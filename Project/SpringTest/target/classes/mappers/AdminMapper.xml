<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.zerock.test.mapper.AdminMapper">
	<select id="selectAll" resultType="com.zerock.test.dto.AdminTestDTO">
        SELECT TEST_IDX, TEST_TEXT FROM TEST
    </select>
    <select id = "Get_ServerInfo"  parameterType = "int"
    		resultType ="com.zerock.test.dto.ServerInfoDTO">
    <![CDATA[
    	SELECT *
			FROM (
			    SELECT *
			    FROM SERVERLOG
			    WHERE TO_DATE(SERVER_DATE || ' ' || SERVER_TIME, 'YYYY-MM-DD HH24:MI:SS') 
			    < FROM_TZ(CAST(SYSDATE AS TIMESTAMP), 'UTC') AT TIME ZONE 'Asia/Seoul'
			    ORDER BY SERVER_DATE DESC, SERVER_TIME DESC
			)
			WHERE ROWNUM <= #{cnt}
			ORDER BY SERVER_DATE ASC, SERVER_TIME ASC
	]]>
    </select>
    
    
    <insert id="ServerLogUpdate2" parameterType="com.zerock.test.dto.ServerInfoDTO">
    	INSERT INTO SERVERLOG VALUES
			(
				#{date},
				#{time},
				#{proces_ProcessCnt},				
				#{proces_IOwait},				
				#{swpd},
				#{free},
				#{buffer},
				#{cache},				
				#{si},
				#{so},
				#{bi},
				#{bo},
				#{in},
				#{cs},
				#{us},
				#{sy},
				#{id},
				#{wa},
				#{st}
			)
    </insert>
   <update id="ServerLogUpdate" parameterType="list">
   BEGIN
        <foreach collection="list" item="item" index="idx" separator="">
         MERGE INTO SERVERLOG trg
            USING (
                SELECT #{item.date} AS SERVER_DATE, #{item.time} AS SERVER_TIME FROM DUAL
            ) src
            ON (trg.SERVER_DATE = src.SERVER_DATE AND trg.SERVER_TIME = src.SERVER_TIME)
            WHEN NOT MATCHED THEN
            	INSERT VALUES
            	(
					#{item.date},
					#{item.time},
					#{item.proces_ProcessCnt},				
					#{item.proces_IOwait},				
					#{item.swpd},
					#{item.free},
					#{item.buffer},
					#{item.cache},				
					#{item.si},
					#{item.so},
					#{item.bi},
					#{item.bo},
					#{item.in},
					#{item.cs},
					#{item.us},
					#{item.sy},
					#{item.id},
					#{item.wa},
					#{item.st}
				);
	    </foreach>
	    END;
	</update>
    <insert id="ServerLogUpdate99" parameterType="list">
    	<foreach collection="list" item="item" index="idx" separator=" " open="INSERT ALL" close="SELECT 1 FROM DUAL">
        INTO SERVERLOG VALUES
			(
				#{item.date},
				#{item.time},
				#{item.proces_ProcessCnt},				
				#{item.proces_IOwait},				
				#{item.swpd},
				#{item.free},
				#{item.buffer},
				#{item.cache},				
				#{item.si},
				#{item.so},
				#{item.bi},
				#{item.bo},
				#{item.in},
				#{item.cs},
				#{item.us},
				#{item.sy},
				#{item.id},
				#{item.wa},
				#{item.st}
			)
	    </foreach>
	</insert>
	
</mapper>